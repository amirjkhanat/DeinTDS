<!-- offers/templates/offer_list.html -->

{% extends 'base_generic.html' %}

{% block content %}
<!-- ... -->

<!-- Add Offer Button -->
<button type="button" class="btn btn-primary float-end mt-1 mb-1" data-bs-toggle="modal" data-bs-target="#addOfferModal">
  Add Offer
</button>

<!-- Add Offer Modal -->
<div class="modal fade" id="addOfferModal" tabindex="-1" aria-labelledby="addOfferModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addOfferModalLabel">Add Offer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
<form id="addOfferForm">
  <div class="mb-3">
    <label for="name" class="form-label">Name</label>
    <input type="text" class="form-control" id="name" v-model="name">
  </div>
  <div class="mb-3">
    <label for="offerType" class="form-label">Offer Type</label>
    <select class="form-select" id="offerType" v-model.lazy="offerType">
      <option value="html_file">HTML File</option>
      <option value="redirect">Redirect</option>
      <option value="preload">Preload</option>
      <option value="action">Action</option>
    </select>
  </div>
{% verbatim %}
<div class="mb-3" v-if="offerType === 'html_file'">
  <label for="htmlFile" class="form-label">HTML File</label>
  <input type="file" class="form-control" id="htmlFile" v-model="htmlFile">
</div>
{% endverbatim %}
  <div class="mb-3" v-if="offerType === 'redirect'">
    <label for="redirectUrl" class="form-label">Redirect URL</label>
    <input type="text" class="form-control" id="redirectUrl" v-model="redirectUrl">
  </div>
  <div class="mb-3" v-if="offerType === 'preload'">
    <label for="preloadUrl" class="form-label">Preload URL</label>
    <input type="text" class="form-control" id="preloadUrl" v-model="preloadUrl">
  </div>
  <div class="mb-3" v-if="offerType === 'action'">
    <label for="actionType" class="form-label">Action Type</label>
    <select class="form-select" id="actionType" v-model="actionType">
      <option value="404">404 Not Found</option>
      <option value="redirect">Redirect to another campaign</option>
      <option value="html">Show as HTML</option>
    </select>
  </div>
  <div class="mb-3" v-if="offerType === 'action' && actionType === 'html'">
    <label for="actionHtml" class="form-label">Action HTML</label>
    <textarea class="form-control" id="actionHtml" v-model="actionHtml"></textarea>
  </div>
  <div class="mb-3" v-if="offerType === 'action' && actionType === 'redirect'">
    <label for="campaign" class="form-label">Campaign</label>
    <select class="form-select" id="campaign" v-model="campaign">
      <!-- Здесь вы можете добавить опции для каждой кампании -->
    </select>
  </div>
  <button type="submit" class="btn btn-primary">Add</button>
</form>
      </div>
    </div>
  </div>
</div>

<!-- Offer List Table -->
<table id="offerTable" class="table table-striped">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">Name</th>
      <th scope="col">Offer Type</th>
      <th scope="col">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for offer in offers %}
    <tr>
      <th scope="row">{{ offer.id }}</th>
      <td>{{ offer.name }}</td>
      <td>{{ offer.get_offer_type_display }}</td>
      <td>
        <button type="button" class="btn btn-primary edit-btn" data-offer-id="{{ offer.id }}">Edit</button>
        <button type="button" class="btn btn-danger delete-btn" data-offer-id="{{ offer.id }}">Delete</button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}

{% block extra_js %}
<script>
new Vue({
  el: '#addOfferForm',
  data: {
    name: '',
    offerType: 'html_file',
    htmlFile: null,
    redirectUrl: '',
    preloadUrl: '',
    actionType: '',
    actionHtml: '',
    campaign: null,
    csrfToken: '{{ csrf_token }}',
    showHtmlFileField: false,
    showRedirectUrlField: false,
    showPreloadUrlField: false,
    showActionTypeField: false,
    showActionHtmlField: false,
    showCampaignField: false,
  },
  methods: {
    handleOfferTypeChange() {
      // Hide all fields
      this.showHtmlFileField = false;
      this.showRedirectUrlField = false;
      this.showPreloadUrlField = false;
      this.showActionTypeField = false;
      this.showActionHtmlField = false;
      this.showCampaignField = false;

      // Show the corresponding field based on the selected offer type
      if (this.offerType === 'html_file') {
        this.showHtmlFileField = true;
      } else if (this.offerType === 'redirect') {
        this.showRedirectUrlField = true;
      } else if (this.offerType === 'preload') {
        this.showPreloadUrlField = true;
      } else if (this.offerType === 'action') {
        this.showActionTypeField = true;
        this.handleActionTypeChange();
      }
    },
    handleActionTypeChange() {
      // Сначала скрываем все поля
      this.showActionHtmlField = false;
      this.showCampaignField = false;

      // Затем показываем соответствующее поле в зависимости от выбранного типа действия
      if (this.actionType === 'html') {
        this.showActionHtmlField = true;
      } else if (this.actionType === 'redirect') {
        this.showCampaignField = true;
      }
    },
    submitForm(event) {
  event.preventDefault();

  let formData = new FormData();
  formData.append('name', this.name);
  formData.append('offer_type', this.offerType);
  formData.append('html_file', this.htmlFile);
  formData.append('redirect_url', this.redirectUrl);
  formData.append('preload_url', this.preloadUrl);
  formData.append('action_type', this.actionType);
  formData.append('action_html', this.actionHtml);
  formData.append('campaign', this.campaign);

  fetch('/admin/api/offers', {
    method: 'POST',
    headers: {
      'X-CSRFToken': this.csrfToken
    },
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    location.reload();
  })
  .catch(error => {
    console.error('There was a problem with the fetch operation:', error);
  });
}
  },
  watch: {
    offerType() {
      this.handleOfferTypeChange();
    },
    actionType() {
      this.handleActionTypeChange();
    }
  },
  created() {
    this.handleOfferTypeChange();
  }
});
</script>
{% endblock %}